name: Continuous Integration (CI) Pipeline

# This workflow is triggered whenever a Pull Request (PR) is opened,
# synchronized (updated), or reopened, ensuring every change is validated.
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]

# Define environment variables
env:
  NODE_VERSION: 15.x
  # Define the path to your application's root relative to the repository root
  APP_DIR: codebase/rdicidr-0.1.0

jobs:
  validate_codebase:
    runs-on: ubuntu-latest

    # Set the default working directory for all 'run' steps in this job
    defaults:
      run:
        working-directory: ${{ env.APP_DIR }}

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # CRITICAL: Point the cache dependency path to the actual location of the lock file
          cache: 'npm'
          cache-dependency-path: ${{ env.APP_DIR }}/package-lock.json

      - name: üì¶ Install Dependencies (Fixing Path Issue)
        # CRITICAL FIX: Explicitly setting working-directory here to guarantee the path is used.
        # This will execute 'npm ci' inside 'codebase/rdicidr-0.1.0'
        run: npm ci
        working-directory: ${{ env.APP_DIR }} # <-- Overriding defaults to guarantee application of the path

      - name: üßπ Run Linter (ESLint)
        run: npm run lint

      - name: üíÖ Run Formatter (Prettier --write)
        run: npm run prettier --write 
        
      - name: ‚úÖ Run Tests (Jest)
        run: CI=true npm run test

      - name: üèóÔ∏è Build Application
        run: npm run build
        
      - name: ‚¨ÜÔ∏è Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build-files
          path: ${{ env.APP_DIR }}/build/
          retention-days: 1
